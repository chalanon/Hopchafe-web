<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout | Hopchafe</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏á Hopchafe */
    :root {
      --primary: #6f4e37;
      --primary-light: #a89f91;
      --secondary: #f7efe5;
      --accent: #c0a98e;
      --text-main: #2e2e2e;
      --text-light: #fff;
    }

    body {
      font-family: "Kanit", sans-serif;
      background: var(--secondary);
      color: var(--text-main);
      margin: 0;
      padding: 0 1rem 3rem;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }

    header {
      text-align: center;
      padding: 1rem 0;
      background-color: var(--primary);
      color: var(--text-light);
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 1.5px;
      border-radius: 0 0 15px 15px;
      margin-bottom: 1rem;
      
    }

    #user-profile-area {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .profile-circle {
      background: var(--primary);
      color: var(--text-light);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 700;
      font-size: 1.25rem;
      
    }

    .profile-name {
      font-size: 1.1rem;
    }

    .logout-btn,
    .login-btn {
      margin-left: auto;
      background: var(--accent);
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 8px;
      color: var(--text-light);
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .logout-btn:hover,
    .login-btn:hover {
      background: var(--primary-light);
    }

    #summaryList {
      background: white;
      padding: 1rem;
      border-radius: 15px;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.1);
      max-height: 220px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    #summaryList .item {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid #ddd;
      font-size: 1rem;
    }
    #summaryList .item:last-child {
      border-bottom: none;
    }

    #total,
    #distanceDisplay,
    #deliveryFeeDisplay {
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 12px;
      border: 1px solid var(--primary-light);
      margin-bottom: 1rem;
      outline-color: var(--primary);
      box-sizing: border-box;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    #payment-section {
      background: white;
      padding: 1rem;
      border-radius: 15px;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.1);
      margin-bottom: 1rem;
    }

    #payment-section label {
      cursor: pointer;
      margin-right: 1rem;
      font-weight: 600;
      
    }

    #qrSection,
    #creditSection {
      margin-top: 1rem;
      border-top: 1px solid #ddd;
      padding-top: 1rem;
      display: none;
    }

    #qrSection img {
      display: block;
      margin: 0 auto 0.5rem;
      width: 160px;
      filter: drop-shadow(0 0 3px var(--primary));
    }

    .pay-btn {
      width: 100%;
      background: var(--primary);
      border: none;
      color: var(--text-light);
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: 700;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 6px 10px rgb(111 78 55 / 0.4);
      
    }
    .pay-btn:hover {
      background: var(--accent);
      box-shadow: 0 8px 12px rgb(192 169 142 / 0.7);
    }

    #minimap {
      height: 320px;
      border-radius: 15px;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.1);
      margin-bottom: 1rem;
      position: relative;
    }

    .map-instructions {
      background: rgba(111, 78, 55, 0.9);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .delivery-zone-info {
      background: rgba(192, 169, 142, 0.1);
      border: 1px solid var(--accent);
      padding: 0.75rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--primary);
    }

    #popupSuccess {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #popupSuccess > div {
      background: white;
      padding: 2rem 3rem;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 6px 15px rgb(111 78 55 / 0.3);
      max-width: 90vw;
    }
    #popupSuccess h2 {
      color: var(--primary);
      margin-bottom: 1rem;
      
    }
    #popupSuccess button {
      background: var(--primary);
      color: var(--text-light);
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1.1rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      
      transition: background-color 0.3s ease;
    }
    #popupSuccess button:hover {
      background: var(--accent);
    }

    /* ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤ admin ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå */
    .admin-link {
      text-align: center;
      margin: 1rem 0 0.5rem;
    }
    .admin-link a {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      font-size: 1rem;
    }
    .admin-link a:hover {
      text-decoration: underline;
      color: var(--accent);
    }

    /* Custom Leaflet Controls */
    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
    }

    .leaflet-control-zoom a {
      background-color: var(--primary) !important;
      color: white !important;
      border: none !important;
    }

    .leaflet-control-zoom a:hover {
      background-color: var(--accent) !important;
    }

    /* Custom popup style */
    .leaflet-popup-content-wrapper {
      background: var(--primary) !important;
      color: white !important;
      border-radius: 8px !important;
    }

    .leaflet-popup-tip {
      background: var(--primary) !important;
    }
  </style>
</head>
<body>

  <header style="background: linear-gradient(90deg,#6f4e37 60%,#c0a98e 100%); color:#fff; box-shadow:0 2px 8px #0002; padding:1.5rem 0; border-radius:0 0 24px 24px; margin-bottom:1.5rem;">
    <img src="https://play-lh.googleusercontent.com/zEe6Ugn1OoFIeP0bYbzqcnP_f0-5HkaYDfwqpMFfBV7Mz0u93XpKUklXXr6ed4uSx7Q" alt="Hopchafe Logo" style="width:60px;vertical-align:middle;margin-right:12px;border-radius:12px;box-shadow:0 2px 8px #0002;">
    <span style="font-size:2rem;font-weight:900;letter-spacing:2px;vertical-align:middle;">Hopchafe Checkout</span>
  </header>

  <div id="user-profile-area" style="margin-bottom:1.5rem;"></div>

  <div style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #0002;padding:1.5rem 1.2rem 1.2rem 1.2rem;margin-bottom:1.5rem;">
    <h2 style="color:#6f4e37;font-size:1.3rem;margin-bottom:1rem;text-align:center;font-weight:700;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span style="font-size:1.1rem;">üõí</span></h2>
    <div id="summaryList" role="list"></div>
    <div id="total" aria-live="polite"></div>
    <div id="distanceDisplay" aria-live="polite"></div>
    <div id="deliveryFeeDisplay" aria-live="polite"></div>
  </div>

  <div style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #0002;padding:1.5rem 1.2rem 1.2rem 1.2rem;margin-bottom:1.5rem;">
    <label for="delivery-method" style="font-size:1.1rem;font-weight:700;color:#6f4e37;margin-bottom:0.5rem;display:block;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span style="font-size:1.1rem;">üöö</span></label>
    <select id="delivery-method" name="delivery-method" aria-required="true">
      <option value="pickup">‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô</option>
      <option value="delivery">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
    </select>
  </div>

  <div id="payment-section" style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #0002;padding:1.5rem 1.2rem 1.2rem 1.2rem;margin-bottom:1.5rem;">
    <label style="font-size:1.1rem;font-weight:700;color:#6f4e37;margin-bottom:0.5rem;display:block;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô <span style="font-size:1.1rem;">üí≥</span></label>
    <label style="margin-right:1rem;"><input type="radio" name="paymethod" value="cash" checked /> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
    <label style="margin-right:1rem;"><input type="radio" name="paymethod" value="qr" /> QR Code</label>
    <label><input type="radio" name="paymethod" value="credit" /> ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label>

    <div id="qrSection" aria-hidden="true">
      <img src="https://promptpay.io/0999999999/100.png" alt="QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" />
      <p style="text-align:center; font-weight:600; color: var(--primary);">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
    </div>

    <div id="creditSection" aria-hidden="true">
      <input id="credit-number" type="text" maxlength="16" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 16 ‡∏´‡∏•‡∏±‡∏Å" inputmode="numeric" autocomplete="cc-number" style="margin-bottom:0.7rem;" />
      <input id="credit-name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£" autocomplete="cc-name" />
    </div>
  </div>

  <div style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #0002;padding:1.5rem 1.2rem 1.2rem 1.2rem;margin-bottom:1.5rem;">
    <h2 style="color:#6f4e37;font-size:1.1rem;margin-bottom:1rem;font-weight:700;text-align:center;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á <span style="font-size:1.1rem;">üó∫Ô∏è</span></h2>
    
    <div class="delivery-zone-info">
      <strong>üéØ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong> ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 2 ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô<br>
      <small>‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ</small>
    </div>
    
    <div class="map-instructions">
      üìç ‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    </div>
    
    <div id="minimap" role="region" aria-label="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á"></div>
  </div>

  <button class="pay-btn" aria-label="‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" style="margin-bottom:1.5rem;">üõçÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>

  <div class="admin-link" style="text-align:center;margin-bottom:0.5rem;">
    <a href="admin_dashboard.html" aria-label="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô" style="color:#6f4e37;font-weight:700;text-decoration:none;font-size:1rem;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Admin)</a>
  </div>
  <div class="admin-link" style="text-align:center;margin-bottom:1.5rem;">
    <a href="order_status.html" aria-label="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" style="color:#6f4e37;font-weight:700;text-decoration:none;font-size:1rem;">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
  </div>

  <div id="popupSuccess" role="alertdialog" aria-modal="true" aria-labelledby="popupTitle" aria-describedby="popupDesc">
    <div>
      <h2 id="popupTitle">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
      <p id="popupDesc">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p>
      <button onclick="window.location.href='order_status.html'">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlNofFy2Q0xZNrQRGdTT-7Tf3ELoL4gZg",
      authDomain: "hopchafe-184ad.firebaseapp.com",
      projectId: "hopchafe-184ad",
      storageBucket: "hopchafe-184ad.appspot.com",
      messagingSenderId: "314546539339",
      appId: "1:314546539339:web:22b31673662662f27236ce"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      const area = document.getElementById('user-profile-area');
      if (user) {
        area.innerHTML = `
          <div class="profile-circle">${user.email[0].toUpperCase()}</div>
          <span class="profile-name">${user.email}</span>
          <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        `;
      } else {
        area.innerHTML = `<a href="login.html"><button class="login-btn">Login / Register</button></a>`;
      }
    });

    window.logout = function() {
      signOut(auth).then(() => {
        location.reload();
      }).catch((error) => {
        alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      });
    };

    // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô: WFR9+32W ‡∏ñ‡∏ô‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏‡∏ò‡∏≤‡∏ô‡∏µ ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏™‡∏á‡∏Ç‡∏•‡∏≤ 90250
    const shopLat = 6.940180;
    const shopLng = 100.467620;

    let userLat = shopLat;
    let userLng = shopLng;
    let deliveryFee = 0;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
    const map = L.map('minimap', {
      center: [shopLat, shopLng],
      zoom: 14,
      zoomControl: true,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      dragging: true
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á custom icon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô
    const shopIcon = L.divIcon({
      html: `<div style="background: #6f4e37; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üè™</div>`,
      className: 'custom-shop-icon',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á custom icon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
    const deliveryIcon = L.divIcon({
      html: `<div style="background: #dc3545; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üìç</div>`,
      className: 'custom-delivery-icon',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° marker ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô
    const shopMarker = L.marker([shopLat, shopLng], { icon: shopIcon })
      .addTo(map)
      .bindPopup('<strong>‡∏£‡πâ‡∏≤‡∏ô Hopchafe</strong><br>‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', { closeOnClick: false })
      .openPopup();

    // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ 2 ‡∏Å‡∏°.‡∏£‡∏≠‡∏ö‡∏£‡πâ‡∏≤‡∏ô - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    const areaCircle = L.circle([shopLat, shopLng], { 
      radius: 2000, 
      color: '#6f4e37',
      weight: 3,
      opacity: 0.8,
      fillColor: '#c0a98e', 
      fillOpacity: 0.2,
      dashArray: '10, 5'
    }).addTo(map);

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô)
    let userMarker = L.marker([shopLat, shopLng], { 
      draggable: true, 
      icon: deliveryIcon 
    }).addTo(map)
    .bindPopup('üì¶ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á<br><small>‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</small>')
    .openPopup();

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å‡πÉ‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á
    function updateDeliveryInfo(lat, lng) {
      const dist = calculateDistance(lat, lng, shopLat, shopLng);
      deliveryFee = Math.max(0, dist * 5); // ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á 5 ‡∏ö‡∏≤‡∏ó‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£
      
      document.getElementById('distanceDisplay').textContent = `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${dist.toFixed(2)} ‡∏Å‡∏°.`;
      document.getElementById('deliveryFeeDisplay').textContent = `‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${deliveryFee.toFixed(0)} ‡∏ö‡∏≤‡∏ó`;
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï popup
      const popupContent = dist <= 2 
        ? `üì¶ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á<br><small>‡∏£‡∏∞‡∏¢‡∏∞: ${dist.toFixed(2)} ‡∏Å‡∏°.</small>`
        : `‚ö†Ô∏è ‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á<br><small>‡∏£‡∏∞‡∏¢‡∏∞: ${dist.toFixed(2)} ‡∏Å‡∏°.</small>`;
      
      userMarker.bindPopup(popupContent);
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å marker
    userMarker.on('dragend', function(e) {
      const { lat, lng } = e.target.getLatLng();
      const dist = calculateDistance(lat, lng, shopLat, shopLng);
      
      if (dist > 2) {
        // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        const angle = Math.atan2(lng - shopLng, lat - shopLat);
        const newLat = shopLat + (1.99 / 111) * Math.cos(angle); // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1.99 ‡∏Å‡∏°
        const newLng = shopLng + (1.99 / (111 * Math.cos(shopLat * Math.PI / 180))) * Math.sin(angle);
        
        userMarker.setLatLng([newLat, newLng]);
        userLat = newLat;
        userLng = newLng;
        
        alert('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î');
      } else {
        userLat = lat;
        userLng = lng;
      }
      
      updateDeliveryInfo(userLat, userLng);
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      const dist = calculateDistance(lat, lng, shopLat, shopLng);
      
      if (dist <= 2) {
        userMarker.setLatLng([lat, lng]);
        userLat = lat;
        userLng = lng;
        updateDeliveryInfo(lat, lng);
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (‡∏£‡∏±‡∏®‡∏°‡∏µ 2 ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£)');
      }
    });

    // ‡∏•‡∏≠‡∏á geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const dist = calculateDistance(lat, lng, shopLat, shopLng);
          
          if (dist <= 2) {
            userMarker.setLatLng([lat, lng]);
            userLat = lat;
            userLng = lng;
            updateDeliveryInfo(lat, lng);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            setTimeout(() => {
              alert('üéØ ‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!\n‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
            }, 1000);
          } else {
            console.log('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
          }
        },
        function(error) {
          console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ:', error.message);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    updateDeliveryInfo(userLat, userLng);

    // Load cart ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    document.addEventListener("DOMContentLoaded", () => {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const summaryList = document.getElementById('summaryList');
      const totalDiv = document.getElementById('total');
      let total = 0;
      
      if (!cart.length) {
        summaryList.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
      } else {
        cart.forEach(item => {
          total += item.price * item.qty;
          const div = document.createElement('div');
          div.className = 'item';
          div.textContent = `${item.name} x${item.qty}`;
          const priceSpan = document.createElement('span');
          priceSpan.textContent = `${item.price * item.qty} ‡∏ö‡∏≤‡∏ó`;
          div.appendChild(priceSpan);
          summaryList.appendChild(div);
        });
        totalDiv.textContent = '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á): ' + total + ' ‡∏ö‡∏≤‡∏ó';
      }
    });

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    document.querySelectorAll('input[name="paymethod"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.getElementById('qrSection').style.display = radio.value === 'qr' ? 'block' : 'none';
        document.getElementById('creditSection').style.display = radio.value === 'credit' ? 'block' : 'none';
      });
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    document.querySelector('.pay-btn').addEventListener('click', async () => {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      console.log('Current user:', currentUser);
      if (!currentUser || !currentUser.uid || !currentUser.email) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå');
        window.location.href = 'login.html';
        return;
      }

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (!cart.length) {
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
        return;
      }

      const paymethod = document.querySelector('input[name="paymethod"]:checked')?.value || 'cash';
      const deliveryMethod = document.getElementById('delivery-method')?.value || 'pickup';

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
      const dist = calculateDistance(userLat, userLng, shopLat, shopLng);
      if (deliveryMethod === 'delivery' && dist > 2) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
        return;
      }

      let total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
      if (deliveryMethod === 'delivery') {
        total += deliveryFee;
      }

      console.log('Order data:', {
        userId: currentUser.uid,
        customer: currentUser.email,
        cart,
        total,
        paymethod,
        deliveryMethod,
        deliveryLat: userLat,
        deliveryLng: userLng,
        distance: dist
      });

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
      if (paymethod === 'credit') {
        const cardNumber = document.getElementById('credit-number').value.trim();
        const cardName = document.getElementById('credit-name').value.trim();
        if (!/^\d{16}$/.test(cardNumber)) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (16 ‡∏´‡∏•‡∏±‡∏Å)');
          return;
        }
        if (!cardName) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
          return;
        }
      }

      try {
        const orderData = {
          userId: currentUser.uid,
          customer: currentUser.email,
          cart,
          total: Math.round(total),
          paymethod,
          deliveryMethod,
          deliveryLat: userLat,
          deliveryLng: userLng,
          distance: Math.round(dist * 100) / 100,
          deliveryFee: deliveryMethod === 'delivery' ? Math.round(deliveryFee) : 0,
          status: "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
          created: serverTimestamp()
        };

        const orderRef = await addDoc(collection(db, "orders"), orderData);
        console.log('Order created with ID:', orderRef.id);
        
        // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        document.getElementById('popupSuccess').style.display = 'flex';
        
        // ‡∏•‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        localStorage.removeItem('cart');
        
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          window.location.href = 'order_status.html';
        }, 3000);
        
      } catch (err) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ' + err.message);
        console.error('Order submit error:', err);
      }
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    document.getElementById('delivery-method').addEventListener('change', function(e) {
      const isDelivery = e.target.value === 'delivery';
      const mapContainer = document.querySelector('#minimap').parentElement;
      
      if (isDelivery) {
        mapContainer.style.display = 'block';
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      } else {
        mapContainer.style.display = 'none';
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á
        deliveryFee = 0;
        document.getElementById('deliveryFeeDisplay').textContent = '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: 0 ‡∏ö‡∏≤‡∏ó';
      }
    });

    // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô)
    if (document.getElementById('delivery-method').value === 'pickup') {
      const mapContainer = document.querySelector('#minimap').parentElement;
      mapContainer.style.display = 'none';
    }
  </script>
</body>
</html>