<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จัดการออเดอร์ | ฝั่งร้าน</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f0f0; margin: 0; padding: 2rem; }
    .container { max-width: 960px; margin: auto; background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 16px #0002; }
    h2 { color: #a08675; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    th, td { border: 1px solid #ddd; padding: 0.7rem; text-align: left; }
    th { background-color: #f7f3ef; color: #4b3631; }
    select { padding: 0.4rem; border-radius: 8px; }
  </style>
</head>
<body>
  <h2 style="text-align:center;color:#6a4c38;margin-top:1rem;">รายการออเดอร์ทั้งหมด</h2>
  <div id="orderList" style="max-width:800px;margin:1rem auto;padding:1rem;background:#fff;border-radius:16px;box-shadow:0 2px 8px #0001;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: import.meta.env.VITE_API_KEY,
    authDomain: import.meta.env.VITE_AUTH_DOMAIN,
    projectId: import.meta.env.VITE_PROJECT_ID,
    storageBucket: import.meta.env.VITE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.VITE_MESSAGING_SENDER_ID,
    appId: import.meta.env.VITE_APP_ID
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const shopLat = 16.215;
    const shopLng = 103.283;

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    const orderListDiv = document.getElementById("orderList");

    function renderOrders(snapshot) {
      orderListDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const html = `
          <div style="border-bottom:1px solid #eee;padding:1rem 0">
            <div><strong>ลูกค้า:</strong> ${data.customer}</div>
            <div><strong>สถานะ:</strong> ${data.status}</div>
            <div><strong>การจัดส่ง:</strong> ${data.deliveryMethod}${data.note ? ` <span style='color:red'>(หมายเหตุ: ${data.note})</span>` : ''}</div>
            <div><strong>ยอดรวม:</strong> ${data.total} บาท</div>
            <div><strong>เวลา:</strong> ${new Date(data.created?.seconds * 1000).toLocaleString()}</div>
          </div>
        `;
        orderListDiv.innerHTML += html;
      });
    }

    onSnapshot(collection(db, "orders"), snapshot => {
      renderOrders(snapshot);

      snapshot.docChanges().forEach(async change => {
        const data = change.doc.data();
        const orderId = change.doc.id;
        const createdTime = data.created?.seconds || 0;
        const now = Math.floor(Date.now() / 1000);
        const timeDiff = now - createdTime;

        if (data.deliveryMethod === "delivery" && data.deliveryLat && data.deliveryLng) {
          const dist = calculateDistance(shopLat, shopLng, parseFloat(data.deliveryLat), parseFloat(data.deliveryLng));
          if (dist > 2) {
            await updateDoc(doc(db, "orders", orderId), {
              deliveryMethod: "pickup",
              note: "อยู่นอกเขตบริการจัดส่ง กรุณารับที่ร้าน"
            });
            return;
          }
        }

        if (data.status === "รอดำเนินการ" && timeDiff >= 180) {
          const newStatus = data.deliveryMethod === "pickup" ? "เสร็จแล้ว มารับได้เลย" : "กำลังจัดส่ง";
          await updateDoc(doc(db, "orders", orderId), {
            status: newStatus,
            updated: serverTimestamp()
          });
        }
        if (data.status === "กำลังจัดส่ง" && timeDiff >= 360) {
          await updateDoc(doc(db, "orders", orderId), {
            status: "จัดส่งสำเร็จ",
            updated: serverTimestamp()
          });
        }
      });
    });
  </script>
</body>
</html>