<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Hopchafe</title>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #6a4c38;
    }
    #orders {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .order {
      border: 1px solid #eee;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .order:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .order:last-child {
      margin-bottom: 0;
    }
    .order h3 {
      margin: 0 0 0.5rem;
      color: #4b3631;
    }
    .status {
      font-weight: bold;
      color: #b77b4c;
      padding: 6px 12px;
      border-radius: 6px;
      display: inline-block;
      background: rgba(183, 123, 76, 0.1);
    }
    
    button {
      background: #b77b4c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #6a4c38;
    }
    
    a {
      text-decoration: none;
      color: inherit;
    }
    select {
      padding: 0.4rem 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô Hopchafe</h1>
  <div id="user-profile-area" style="display:flex;align-items:center;gap:12px;margin-bottom:24px;"></div>
  <div id="orders">
    <div id="order-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...</div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    onSnapshot,
    updateDoc,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

  const firebaseConfig = {
  apiKey: import.meta.env.VITE_API_KEY,
  authDomain: import.meta.env.VITE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_APP_ID
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);


  import { getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  let currentUser = null;

  onAuthStateChanged(auth, async user => {
    currentUser = user;
    const profileArea = document.getElementById('user-profile-area');
    if (user) {
      // ‡∏î‡∏∂‡∏á role ‡∏à‡∏≤‡∏Å Firestore
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const userData = userDoc.exists() ? userDoc.data() : {};
      const role = userData.role || '';
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡πâ‡∏≤‡∏ô redirect ‡∏≠‡∏≠‡∏Å
      if (role !== 'admin' && role !== '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡πâ‡∏≤‡∏ô') {
        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
        window.location.href = 'index.html';
        return;
      }
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      profileArea.innerHTML = `
        <div class="profile-circle">${(userData.username ? userData.username[0] : user.email[0]).toUpperCase()}</div>
        <span class="profile-name">${userData.username || user.email}</span>
        <span style="color:#b77b4c;font-weight:bold;">(${role})</span>
        <button onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      `;

      // ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö realtime
      if(document.getElementById('order-list')) {
        const ordersRef = collection(db, 'orders');
        const q = query(ordersRef, orderBy('created', 'desc'));
        onSnapshot(q, snapshot => {
          const orderList = document.getElementById('order-list');
          if (snapshot.empty) {
            orderList.innerHTML = '<div style="text-align:center;color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>';
            return;
          }
          orderList.innerHTML = '';
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const orderId = docSnap.id;
            const div = document.createElement('div');
            div.className = 'order';
            let cartItems = '';
            if (data.cart && data.cart.length > 0) {
              cartItems = data.cart.map(item => `
                <div style="display:flex;justify-content:space-between;padding:8px;background:#f9f9f9;margin:4px 0;border-radius:6px;">
                  <div>
                    <strong>${item.name}</strong>
                    ${item.topping ? `<br><small>‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á: ${item.topping}</small>` : ''}
                    ${item.sweetness ? `<br><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô: ${item.sweetness}</small>` : ''}
                  </div>
                  <div style="text-align:right;">
                    <div>${item.price} ‡∏ö‡∏≤‡∏ó √ó ${item.qty}</div>
                    <div><strong>${item.price * item.qty} ‡∏ö‡∏≤‡∏ó</strong></div>
                  </div>
                </div>
              `).join('');
            }

            let deliveryInfo = '';
            if (data.deliveryMethod === 'delivery') {
              deliveryInfo = `
                <div style="margin-top:10px;padding:10px;background:#fff8e1;border-radius:6px;">
                  <div><strong>üöö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</strong></div>
                  <div>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${data.distance || 0} ‡∏Å‡∏°.</div>
                  <div>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á: ${data.deliveryFee || 0} ‡∏ö‡∏≤‡∏ó</div>
                  <div>‡∏û‡∏¥‡∏Å‡∏±‡∏î: <a href="https://www.google.com/maps?q=${data.deliveryLat},${data.deliveryLng}" target="_blank" style="color:#1a73e8;">‡∏î‡∏π‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a></div>
                </div>
              `;
            }

            div.innerHTML = `
              <div style="border-left:4px solid #b77b4c;padding-left:10px;margin-bottom:15px;">
                <h3 style="margin:0;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${orderId}</h3>
                <div style="color:#666;font-size:0.9em;">
                  ${data.created ? new Date(data.created.seconds*1000).toLocaleString('th-TH') : '-'}
                </div>
              </div>

              <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:15px;">
                <div>
                  <div style="font-weight:bold;margin-bottom:5px;">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                  <div style="padding:10px;background:#f5f5f5;border-radius:6px;">
                    <div>${data.customer || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
                    <div style="margin-top:5px;">
                      <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${data.deliveryMethod === 'delivery' ? '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á' : '‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô'}
                    </div>
                    <div style="margin-top:5px;">
                      <strong>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${data.paymethod || '-'}
                    </div>
                  </div>
                </div>

                <div>
                  <div style="font-weight:bold;margin-bottom:5px;">üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                  <div style="padding:10px;background:#f5f5f5;border-radius:6px;">
                    <div class="status" style="font-size:1.1em;color:#b77b4c;">
                      ${data.status || '-'}
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-bottom:15px;">
                <div style="font-weight:bold;margin-bottom:5px;">üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                <div style="border:1px solid #eee;border-radius:6px;padding:10px;">
                  ${cartItems}
                  <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #ddd;">
                    <div style="display:flex;justify-content:space-between;">
                      <strong>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong>
                      <strong>${data.total - (data.deliveryFee || 0)} ‡∏ö‡∏≤‡∏ó</strong>
                    </div>
                    ${data.deliveryFee ? `
                      <div style="display:flex;justify-content:space-between;margin-top:5px;">
                        <span>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>
                        <span>${data.deliveryFee} ‡∏ö‡∏≤‡∏ó</span>
                      </div>
                    ` : ''}
                    <div style="display:flex;justify-content:space-between;margin-top:5px;font-size:1.2em;font-weight:bold;color:#b77b4c;">
                      <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                      <span>${data.total} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                  </div>
                </div>
              </div>

              ${deliveryInfo}
            `;
            // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const btnNextStatus = document.createElement('button');
            btnNextStatus.textContent = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
            btnNextStatus.style.marginTop = '8px';
            btnNextStatus.onclick = async () => {
              const nextStatus = getNextStatus(data.status);
              if(nextStatus) {
                await updateDoc(doc(db, 'orders', orderId), { status: nextStatus });
                alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
              }
            };
            div.appendChild(btnNextStatus);
            orderList.appendChild(div);
          });
        });
      }

    } else {
      // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
      if(profileArea)
        profileArea.innerHTML = `<a href="admin_login.html">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Admin)</a>`;
    }
  });

  window.logout = function() {
    signOut(auth).then(() => location.reload());
  };

  function getNextStatus(current) {
    switch(current) {
      case '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°';
      case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°': return '‡∏≠‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏™‡πà‡∏á';
      case '‡∏≠‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏™‡πà‡∏á': return '‡∏ñ‡∏∂‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
      default: return null;
    }
  }
</script>
</body>
</html>
