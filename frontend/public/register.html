<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å | Hopchafe</title>
  
  <!-- Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="common.css" rel="stylesheet">
  
  <style>
    body { background: #f8f8f8; font-family: 'Sarabun', sans-serif; margin:0; padding:0; min-height:100vh; display:flex; align-items:center; justify-content:center;}
    .container { background:#fff; border-radius:16px; box-shadow:0 2px 12px #0002; padding:2.5rem 2rem 2rem 2rem; max-width:430px; width:100%; margin:32px 0;}
    h2 { color:#6a4c38; text-align:center; margin-bottom:1.5rem; font-size:2rem; font-weight:bold;}
    form { display:flex; flex-direction:column; gap:1rem;}
    label { font-weight:600; color:#4e342e; margin-bottom:0.2em;}
    input { padding:0.7em; border-radius:8px; border:1px solid #ccc; font-size:1em; margin-bottom:0.5em;}
    button { padding:0.7em 1.2em; border-radius:24px; border:none; font-weight:bold; font-size:1.1em; cursor:pointer; transition:background 0.2s, transform 0.2s;}
    button:hover { transform: translateY(-2px);}
    button[type="submit"] { background:#b77b4c; color:#fff; width:100%; margin-top:0.5em;}
    button[type="submit"]:hover { background:#6a4c38;}
    .btn-menu { background:#6a4c38; color:#fff; display:inline-flex; align-items:center; gap:0.5em; margin-right:1em;}
    .btn-menu:hover { background:#8B5E3C;}
    .button-group { display:flex; align-items:center; justify-content:center; margin-top:1.2em; gap:1rem;}
    .switch-link { text-align:center; margin-top:1em; color:#6a4c38; cursor:pointer; text-decoration:underline; font-size:0.98em;}
    @media (max-width:480px) {.button-group { flex-direction:column; gap:0.8rem;} .btn-menu { width:100%; margin-right:0; justify-content:center;}}
    .error-message { color:#e53935; text-align:center; margin-top:8px; font-size:1em; font-weight:500;}
    .success-message { color:#388e3c; text-align:center; margin-top:8px; font-size:1em; font-weight:500;}
    .hidden { display:none;}
  </style>
</head>
<body>
  <div class="container">
    <!-- üîπ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö -->
    <div id="login-form-block">
      <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <form id="loginForm">
        <label for="login-username">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" id="login-username" required autocomplete="username">
        <label for="login-password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="login-password" required autocomplete="current-password">
        <button type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
      <div class="switch-link" onclick="showRegister()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
      <div class="button-group">
        <button class="btn-menu" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π
        </button>
      </div>
      <div id="login-error" class="error-message"></div>
    </div>

    <!-- üîπ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
    <div id="register-form-block" class="hidden">
      <h2>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
      <form id="registerForm">
        <label for="reg-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <input type="text" id="reg-username" required>
        <label for="reg-email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" id="reg-email" required>
        <label for="reg-password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="reg-password" required>
        <label for="reg-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="reg-confirm" required>
        <button type="submit">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </form>
      <div class="switch-link" onclick="showLogin()">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
      <div class="button-group">
        <button class="btn-menu" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π
        </button>
      </div>
      <div id="register-error" class="error-message"></div>
      <div id="register-success" class="success-message"></div>
    </div>
  </div>

  <script>
    function showRegister() {
      document.getElementById('login-form-block').classList.add('hidden');
      document.getElementById('register-form-block').classList.remove('hidden');
      document.getElementById('login-error').innerText = '';
    }
    function showLogin() {
      document.getElementById('register-form-block').classList.add('hidden');
      document.getElementById('login-form-block').classList.remove('hidden');
      document.getElementById('register-error').innerText = '';
      document.getElementById('register-success').innerText = '';
    }
  </script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getFirestore, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlNofFy2Q0xZNrQRGdTT-7Tf3ELoL4gZg",
  authDomain: "hopchafe-184ad.firebaseapp.com",
  databaseURL: "https://hopchafe-184ad-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hopchafe-184ad",
  storageBucket: "hopchafe-184ad.firebasestorage.app",
  messagingSenderId: "314546539339",
  appId: "1:314546539339:web:22b31673662662f27236ce",
  measurementId: "G-JDMJ19MRNC"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// üîπ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
document.getElementById('registerForm').onsubmit = async function(e) {
  e.preventDefault();
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const confirm = document.getElementById('reg-confirm').value;
  const role = "user";
  const errorDiv = document.getElementById('register-error');
  const successDiv = document.getElementById('register-success');
  errorDiv.innerText = '';
  successDiv.innerText = '';

  if (password !== confirm) {
    errorDiv.innerText = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
    return;
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    await setDoc(doc(db, "users", user.uid), {
      email: user.email,
      username,
      role
    });

    localStorage.setItem('loginUser', JSON.stringify({ email: user.email, uid: user.uid, username, role }));
    successDiv.innerText = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';

    // redirect ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏á register
    setTimeout(() => {
      const redirectURL = sessionStorage.getItem('redirectAfterLogin');
      sessionStorage.removeItem('redirectAfterLogin');

      if (redirectURL) {
        window.location.href = redirectURL;
      } else {
        showLogin();
        document.getElementById('login-username').value = email;
      }
    }, 1500);

  } catch (err) {
    console.log('Register Error:', err);
    if (err.code === 'auth/email-already-in-use') errorDiv.innerText = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
    else if (err.code === 'auth/invalid-email') errorDiv.innerText = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    else if (err.code === 'auth/weak-password') errorDiv.innerText = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
    else errorDiv.innerText = err.message;
  }
};

// üîπ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  const email = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errorDiv = document.getElementById('login-error');
  errorDiv.innerText = '';

  if (!email.match(/^\S+@\S+\.\S+$/)) {
    errorDiv.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    return;
  }

  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    const userDoc = await getDoc(doc(db, "users", user.uid));
    let role = "user";
    let username = "";
    if (userDoc.exists()) {
      const data = userDoc.data();
      role = data.role || "user";
      username = data.username || "";
    }

    localStorage.setItem('loginUser', JSON.stringify({ email: user.email, uid: user.uid, username, role }));

    const redirectURL = sessionStorage.getItem('redirectAfterLogin');
    sessionStorage.removeItem('redirectAfterLogin');

    if (role === "admin") window.location.href = 'admin-dashboard.html';
    else if (redirectURL) window.location.href = redirectURL;
    else window.location.href = 'index.html';

  } catch (err) {
    console.log('Login Error:', err);
    if (err.code === 'auth/user-not-found') errorDiv.innerText = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ';
    else if (err.code === 'auth/wrong-password') errorDiv.innerText = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    else if (err.code === 'auth/too-many-requests') errorDiv.innerText = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß';
    else errorDiv.innerText = err.message;
  }
};
</script>
</body>
</html>
